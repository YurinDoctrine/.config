#!/usr/bin/env bash

if [[ $1 = '--first-run' ]]; then # First run
    xterm -e cbpp-welcome
    exit 0
fi

say() {
    fold -s -w 76 <<<"$1" | sed -e 's/^/  /' # wraps text nicely and adds two leading spaces
    sleep "${2-0}"
}

connectiontest() {
    rfkill unblock wifi
    local TEXT_CHECKING='Checking internet connection...'
    local TEXT_FAILED='Internet connection test failed!'
    local TEXT_ABORT='Please connect to an Internet first.'
    local TEXT_OK='Internet connection test passed!'

    local -i i attempts=${1-0}

    for ((i = 0; i < attempts || attempts == 0; i++)); do
        say "$TEXT_CHECKING"
        if wget -qO - 'http://ftp.debian.org/debian/README' &>/dev/null; then
            say "$TEXT_OK" 1
            return 0
        fi
        say "$TEXT_FAILED" 1
        if ((i == attempts)); then # if last attempt
            say "$TEXT_ABORT"
            ((attempts == 1)) && return 1
        fi
    done
}
sleep 5s
connectiontest
clear

doas wget -qO /usr/bin/cbpp-include.cfg https://raw.githubusercontent.com/YurinDoctrine/.config/artix/cbpp-include.cfg &&
    if ! . cbpp-include.cfg 2>/dev/null; then
        echo '  Failed to locate cbpp-include.cfg in PATH' >&2
        exit 1
    fi
trap 'postinstall' SIGINT && postinstall

cd /tmp
wget -qO config.zip https://github.com/YurinDoctrine/.config/archive/refs/heads/artix.zip && unzip config.zip && mv .config-artix .config
doas cp -rfd /etc/skel/.config/openbox/autostart .config/openbox/autostart
doas rm -rfd /etc/skel/.*
doas mkdir /etc/skel/.config
doas mkdir /etc/skel/.local
doas cp -rfd .config/.gmrunrc /etc/skel
doas cp -rfd .config/.gtkrc-2.0 /etc/skel/.gtkrc-2.0
doas cp -rfd .config/.fonts.conf /etc/skel
doas cp -rfd .config/.gtk-bookmarks /etc/skel
doas cp -rfd .config/.vimrc /etc/skel
doas cp -rfd .config/.xinitrc /etc/skel
doas cp -rfd .config/.Xresources /etc/skel
doas cp -rfd .config/.nanorc /etc/skel
doas cp -rfd .config/.mkshrc /etc/skel
doas cp -rfd .config/.profile /etc/skel
doas cp -rfd .config/.bashrc /etc/skel
doas cp -rfd .config/.tmux.conf /etc/skel
doas cp -rfd .config/.newsboat /etc/skel/.newsboat
doas cp -rfd .config/.irssi /etc/skel/.irssi
doas rm -rfd .config/CBPP
doas rm -rfd .config/themes
doas rm -rfd .config/openbox-3
doas cp -rfd .config/* /etc/skel/.config
doas cp -rfd .config/.local/* /etc/skel/.local
cd /home/$USER

BAT=$(ls /sys/class/power_supply/ | grep BAT)
doas sed -i -e "s/BAT1.*/$BAT/g" /home/$USER/.config/polybar/config.ini

doas sed -i -e 's/^(sleep 5s && exec cbpp-welcome --first-run) &/#(sleep 5s && exec cbpp-welcome --first-run) &/' /home/$USER/.config/openbox/autostart
doas sed -i -e 's/^(sleep 5s && exec cbpp-welcome --first-run) &/#(sleep 5s && exec cbpp-welcome --first-run) &/' /root/.config/openbox/autostart

doas sed -i -e 's/NoDisplay=true/NoDisplay=false/g' /etc/xdg/autostart/*.desktop

doas mkdir /usr/share/desktop-directories
doas mkdir /home/$USER/templates
doas mkdir /home/$USER/public
doas mkdir /home/$USER/desktop
doas mkdir /home/$USER/documents
doas mkdir /home/$USER/downloads
doas mkdir /home/$USER/images
doas mkdir /home/$USER/music
doas mkdir /home/$USER/videos
doas mkdir -p /home/$USER/.compose-cache
doas touch /home/$USER/.XCompose
doas chown -hR $USER:$USER /home/$USER
doas chown -hR root:root /etc/skel/backup
doas mkdir /opt/.var
doas mkdir /opt/Trash
doas chown -hR $USER:$USER /opt

doas ln -s /opt/.var /home/$USER/
doas ln -s /opt/Trash /home/$USER/.local/share/
doas ln -s /opt/ /home/$USER/
doas ln -s /tmp/ /home/$USER/
doas ln -s /etc/skel/backup/ /home/$USER/

gsettings set org.gnome.system.location enabled false
gsettings set org.gnome.desktop.privacy disable-camera true
gsettings set org.gnome.desktop.privacy disable-microphone true
gsettings set org.gnome.desktop.privacy remember-recent-files false
gsettings set org.gnome.desktop.privacy hide-identity true
gsettings set org.gnome.desktop.privacy report-technical-problems false
gsettings set org.gnome.desktop.privacy send-software-usage-stats false
gsettings set org.gnome.login-screen allowed-failures 5
gsettings set org.gnome.desktop.screensaver user-switch-enabled false
gsettings set org.gnome.SessionManager logout-prompt false
gsettings set org.gnome.desktop.media-handling autorun-never true
gsettings set org.gnome.desktop.sound event-sounds false
gsettings set org.gnome.settings-daemon.plugins.media-keys max-screencast-length 0
gsettings set org.gnome.desktop.session idle-delay 0
gsettings set org.gnome.settings-daemon.plugins.power sleep-inactive-ac-type 'nothing'
gsettings set org.gnome.settings-daemon.plugins.power sleep-inactive-battery-type 'nothing'
gsettings set org.gnome.settings-daemon.plugins.power power-button-action 'interactive'
gsettings set org.gnome.desktop.interface enable-animations false
gsettings set org.gnome.desktop.interface scaling-factor 1
gsettings set org.gnome.desktop.interface text-scaling-factor 1.2
gsettings set org.gnome.mutter experimental-features "['x11-randr-fractional-scaling'"', '"'scale-monitor-framebuffer']"
gsettings set org.gnome.settings-daemon.plugins.xsettings antialiasing 'rgba'
gsettings set org.gnome.settings-daemon.plugins.xsettings hinting 'slight'
gsettings set org.gnome.desktop.peripherals.keyboard delay 500
gsettings set org.gnome.desktop.peripherals.keyboard repeat-interval 100
gsettings set org.gnome.desktop.peripherals.mouse accel-profile flat
gsettings set org.gtk.Settings.FileChooser show-hidden true
gsettings set org.gnome.mutter attach-modal-dialogs false
gsettings set org.gnome.shell.overrides attach-modal-dialogs false
gsettings set org.gnome.shell.overrides edge-tiling true
gsettings set org.gnome.mutter edge-tiling true
gsettings set org.gnome.desktop.background color-shading-type vertical

if [ -f "/home/$USER/.config/gtk-3.0/bookmarks" ]; then
    sed -i -e "s/\$USER/$(whoami)/g" /home/$USER/.config/gtk-3.0/bookmarks >/dev/null 2>&1
fi

if [ -f "/home/$USER/.config/user-dirs.dirs" ]; then
    sed -i -e "s/\$USER/$(whoami)/g" /home/$USER/.config/user-dirs.dirs >/dev/null 2>&1
fi

if [ -f "/home/$USER/.gtk-bookmarks" ]; then
    sed -i -e "s/\$USER/$(whoami)/g" /home/$USER/.gtk-bookmarks >/dev/null 2>&1
fi

xdg-user-dirs-update

gtk-update-icon-cache

fc-cache -rfv

for dir in $HOME $HOME/*/; do touch "$dir/.metadata_never_index" "$dir/.noindex" "$dir/.nomedia" "$dir/.trackerignore"; done

doas rm -rfd /usr/share/xsessions/openbox-kde.desktop

doas flatpak remote-add --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo

doas rm -rfd /var/lib/pacman/db.lck

doas pacman -S --needed --noconfirm --disable-download-timeout jq which xclip xmlstarlet

echo -e "[Trigger]
Operation = Install
Operation = Upgrade
Type = Package
Target = bash

[Action]
When = PostTransaction
Exec = /sbin/ln -sfT $(which mksh) /bin/sh" | doas tee /etc/pacman.d/hooks/set-sh-back-to-mksh.hook

doas cp -rfd /etc/pacman.conf.bak /etc/pacman.conf

echo -e "
# Arch
#[extra]
#Include = /etc/pacman.d/mirrorlist-arch

#[community]
#Include = /etc/pacman.d/mirrorlist-arch

#[multilib]
#Include = /etc/pacman.d/mirrorlist-arch
" | doas tee -a /etc/pacman.conf

yes | doas pacman -Scc

doas sed -i -e '2c export LD_PRELOAD=' /bin/xdg-open

echo '#!/bin/sh
export LD_PRELOAD= && exec /usr/lib/firefox-esr/firefox-esr -safe-mode -purgecaches "$@"' | doas tee /bin/firefox-esr

echo -e "export LD_PRELOAD=/usr/lib/libtcmalloc_minimal.so" | tee -a /home/$USER/.config/openbox/environment
echo -e "export LD_PRELOAD=/usr/lib/libtcmalloc_minimal.so" | doas tee -a /root/.config/openbox/environment

echo -e "nameserver 9.9.9.11
nameserver 149.112.112.11
options timeout:1 attempts:3 trust-ad single-request bogus-priv stop-dns-rebind domain-needed" | doas tee /etc/resolv.conf && doas chattr +i /etc/resolv.conf

wget -qO /home/$USER/.local/bin/cbpp-include.cfg https://raw.githubusercontent.com/YurinDoctrine/.config/artix/.local/bin/cbpp-include.cfg

firefox-esr -headless &
sleep 5s && pkill firefox-esr
cd /home/$USER/.mozilla/firefox-esr/*default-release*/ && wget -q https://raw.githubusercontent.com/arkenfox/user.js/master/user.js && sed -i -e 's/user_pref("browser.download.useDownloadDir", false);/\/\/user_pref("browser.download.useDownloadDir", false);/' user.js && sed -i -e 's/user_pref("browser.urlbar.placeholderName", .*/user_pref("browser.urlbar.placeholderName", "DuckDuckGo");/' prefs.js && sed -i -e 's/user_pref("browser.urlbar.placeholderName.private", .*/user_pref("browser.urlbar.placeholderName.private", "DuckDuckGo");/' prefs.js
echo -e 'user_pref("network.proxy.type", 1);
user_pref("network.proxy.socks", "127.0.0.1");
user_pref("network.proxy.socks_port", 9050);
user_pref("network.proxy.socks_version", 5);' | tee -a prefs.js
cd

echo -e "/sbin/echo -n guided | tee /sys/devices/system/cpu/amd_pstate/status
/sbin/echo -n guided | tee /sys/devices/system/cpu/intel_pstate/status
/sbin/echo -n conservative | tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor
/sbin/echo -n power | tee /sys/devices/system/cpu/cpufreq/policy*/energy_performance_preference
/sbin/echo -n powersupersave | tee /sys/module/pcie_aspm/parameters/policy
/sbin/fstrim -a -v
/sbin/preload -c /etc/preload.conf -s '' -l '' -n19
/sbin/swapon /swap/swapfile
/sbin/mount -o noatime,nosuid,nodev -t tmpfs tmpfs /home/$USER
/sbin/rsync -a --exclude='backup/' /etc/skel/ /home/$USER/
/sbin/chown -hR $USER:$USER /home/$USER
/sbin/mount -o noatime,nosuid,nodev -t tmpfs tmpfs /tmp
/sbin/mount -o noatime,nosuid,nodev,noexec -t tmpfs tmpfs /var/tmp
/sbin/mount -o noatime,nosuid,nodev,noexec -t tmpfs tmpfs /var/cache
/sbin/mount -o noatime,nosuid,nodev,noexec -t tmpfs tmpfs /var/log
/sbin/mount -o remount,noatime,nosuid,nodev,noexec -t tmpfs shm /dev/shm
/sbin/sync" | doas tee /etc/rc.local

doas chsh -s $(which mksh) $(whoami)
doas chsh -s $(which mksh) root
doas ln -sfT $(which mksh) /bin/sh

doas rm -rfd /boot/grub/themes && doas update-grub

tmux kill-server

openbox --exit && exit
